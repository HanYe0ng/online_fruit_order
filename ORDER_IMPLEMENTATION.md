# ë¬´ì¸ ê³¼ì¼ê°€ê²Œ ì£¼ë¬¸ ì‹œìŠ¤í…œ - êµ¬í˜„ ê°€ì´ë“œ

## êµ¬í˜„ëœ ì£¼ë¬¸ ê¸°ëŠ¥

### âœ… í•µì‹¬ êµ¬í˜„ ì‚¬í•­

#### 1. ì£¼ë¬¸ ìƒì„± ì‹œ ì¬ê³  ê´€ë¦¬
- **ì¬ê³  í™•ì¸**: ì£¼ë¬¸ ì „ ëª¨ë“  ìƒí’ˆì˜ ì¬ê³  ìƒíƒœë¥¼ í™•ì¸
- **ì›ìì  ì²˜ë¦¬**: ì£¼ë¬¸ ìƒì„±ê³¼ ì¬ê³  ì°¨ê°ì„ íŠ¸ëœì­ì…˜ì²˜ëŸ¼ ì²˜ë¦¬
- **ë¡¤ë°± ì²˜ë¦¬**: ì˜¤ë¥˜ ë°œìƒ ì‹œ ì£¼ë¬¸ ë°ì´í„° ìë™ ë¡¤ë°±
- **í’ˆì ˆ ì²˜ë¦¬**: ì¬ê³  0ì¼ ë•Œ ìë™ìœ¼ë¡œ `is_soldout` í”Œë˜ê·¸ ì—…ë°ì´íŠ¸

#### 2. ì‹¤ì‹œê°„ ì¬ê³  í™•ì¸
```typescript
// ì¥ë°”êµ¬ë‹ˆì—ì„œ ì£¼ë¬¸í•˜ê¸° ì „ ì‹¤ì‹œê°„ ì¬ê³  í™•ì¸
const handleCheckoutClick = async () => {
  const stockResult = await checkCartItemsStock(items)
  if (stockResult.isAvailable) {
    // ì£¼ë¬¸ ì§„í–‰
  } else {
    // ì¬ê³  ë¶€ì¡± ì•Œë¦¼
  }
}
```

#### 3. í–¥ìƒëœ ì—ëŸ¬ ì²˜ë¦¬
- ì¬ê³  ë¶€ì¡± ì—ëŸ¬
- í’ˆì ˆ ìƒí’ˆ ì—ëŸ¬  
- ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜
- ë°ì´í„°ë² ì´ìŠ¤ ì œì•½ ì¡°ê±´ ìœ„ë°˜

### ğŸ“ ìˆ˜ì •ëœ íŒŒì¼ë“¤

#### `src/services/order.ts`
```typescript
async createOrder(orderData: CreateOrderData) {
  // 1. ì¬ê³  í™•ì¸
  // 2. ì£¼ë¬¸ ìƒì„±  
  // 3. ì£¼ë¬¸ ìƒì„¸ ìƒì„±
  // 4. ì¬ê³  ì°¨ê° (Supabase RPC ì‚¬ìš©)
  // 5. ì˜¤ë¥˜ ì‹œ ë¡¤ë°±
}

async cancelOrder(orderId: number) {
  // ì£¼ë¬¸ ì·¨ì†Œ ì‹œ ì¬ê³  ë³µêµ¬
}
```

#### `src/utils/stockCheck.ts`
```typescript
export const checkCartItemsStock = async (cartItems) => {
  // ì‹¤ì‹œê°„ ì¬ê³  ìƒíƒœ í™•ì¸
  // ë¶€ì¡±í•œ ìƒí’ˆ ëª©ë¡ ë°˜í™˜
}
```

#### `src/components/customer/Cart.tsx`
```typescript
const handleCheckoutClick = async () => {
  // ì£¼ë¬¸ ì „ ì‹¤ì‹œê°„ ì¬ê³  í™•ì¸
  // ì‚¬ìš©ì ì¹œí™”ì ì¸ ì—ëŸ¬ ë©”ì‹œì§€
}
```

## ğŸ—„ï¸ ë°ì´í„°ë² ì´ìŠ¤ í•¨ìˆ˜ ì„¤ì •

Supabase ëŒ€ì‹œë³´ë“œì˜ SQL Editorì—ì„œ ë‹¤ìŒ í•¨ìˆ˜ë“¤ì„ ì‹¤í–‰í•˜ì„¸ìš”:

```sql
-- ì¬ê³  ì°¨ê° í•¨ìˆ˜
CREATE OR REPLACE FUNCTION decrease_product_quantity(
  product_id bigint,
  decrease_amount integer
) RETURNS void AS $$
BEGIN
  UPDATE products 
  SET quantity = quantity - decrease_amount,
      is_soldout = CASE 
        WHEN quantity - decrease_amount <= 0 THEN true 
        ELSE is_soldout 
      END
  WHERE id = product_id;
END;
$$ LANGUAGE plpgsql;

-- ì¬ê³  ë³µêµ¬ í•¨ìˆ˜ (ì£¼ë¬¸ ì·¨ì†Œìš©)
CREATE OR REPLACE FUNCTION increase_product_quantity(
  product_id bigint,
  increase_amount integer
) RETURNS void AS $$
BEGIN
  UPDATE products 
  SET quantity = quantity + increase_amount,
      is_soldout = false
  WHERE id = product_id;
END;
$$ LANGUAGE plpgsql;
```

## ğŸ”„ ì£¼ë¬¸ í”„ë¡œì„¸ìŠ¤ í”Œë¡œìš°

```
1. ê³ ê°ì´ ì¥ë°”êµ¬ë‹ˆì—ì„œ "ì£¼ë¬¸í•˜ê¸°" í´ë¦­
   â†“
2. ì‹¤ì‹œê°„ ì¬ê³  í™•ì¸ (checkCartItemsStock)
   â†“
3. ì¬ê³  ì¶©ë¶„ â†’ ì£¼ë¬¸ í¼ í‘œì‹œ
   ì¬ê³  ë¶€ì¡± â†’ ê²½ê³  ë©”ì‹œì§€ + ìˆ˜ëŸ‰ ì¡°ì • ìš”ì²­
   â†“
4. ì£¼ë¬¸ í¼ ì œì¶œ
   â†“
5. ì•„íŒŒíŠ¸ ì„¸ëŒ€ ì°¾ê¸°/ìƒì„± (findOrCreateApartmentUnit)
   â†“
6. ì£¼ë¬¸ ìƒì„± í”„ë¡œì„¸ìŠ¤:
   - ì¬ê³  ì¬í™•ì¸
   - ì£¼ë¬¸ í…Œì´ë¸” ìƒì„±
   - ì£¼ë¬¸ ìƒì„¸ í…Œì´ë¸” ìƒì„±
   - ì¬ê³  ì°¨ê° (decrease_product_quantity RPC)
   â†“
7. ì„±ê³µ ì‹œ:
   - ì¥ë°”êµ¬ë‹ˆ ë¹„ìš°ê¸°
   - ìƒí’ˆ ëª©ë¡ ìƒˆë¡œê³ ì¹¨ (ì¬ê³  ì—…ë°ì´íŠ¸ ë°˜ì˜)
   - ì£¼ë¬¸ ì™„ë£Œ í˜ì´ì§€ë¡œ ì´ë™
```

## ğŸ¯ ì¶”ê°€ ê°œì„  ê°€ëŠ¥ ì‚¬í•­

### 1. ë™ì‹œì„± ì œì–´
í˜„ì¬ëŠ” ê¸°ë³¸ì ì¸ ì¬ê³  í™•ì¸ë§Œ í•˜ë¯€ë¡œ, ë†’ì€ ë™ì‹œì„±ì´ í•„ìš”í•œ ê²½ìš° ë‹¤ìŒì„ ê³ ë ¤:
- PostgreSQLì˜ `SELECT ... FOR UPDATE` ì‚¬ìš©
- ë‚™ê´€ì  ë½í‚¹ êµ¬í˜„
- Redisë¥¼ ì´ìš©í•œ ë¶„ì‚° ë½

### 2. ì£¼ë¬¸ ìƒíƒœ ê´€ë¦¬
```typescript
enum OrderStatus {
  PENDING = 'ì ‘ìˆ˜ë¨',
  PREPARING = 'ì¤€ë¹„ì¤‘', 
  DELIVERING = 'ë°°ë‹¬ì¤‘',
  COMPLETED = 'ì™„ë£Œ',
  CANCELLED = 'ì·¨ì†Œë¨'
}
```

### 3. ì•Œë¦¼ ì‹œìŠ¤í…œ
- ì£¼ë¬¸ ì ‘ìˆ˜ ì•Œë¦¼ (ê´€ë¦¬ììš©)
- ì£¼ë¬¸ ìƒíƒœ ë³€ê²½ ì•Œë¦¼ (ê³ ê°ìš©)
- WebSocket ë˜ëŠ” Server-Sent Events í™œìš©

### 4. ê²°ì œ ì—°ë™
- PGì‚¬ ì—°ë™ (í† ìŠ¤í˜ì´, ì¹´ì¹´ì˜¤í˜ì´ ë“±)
- ë¬´í†µì¥ì…ê¸ˆ í™•ì¸ ì‹œìŠ¤í…œ

## ğŸš€ ë‹¤ìŒ ë‹¨ê³„ êµ¬í˜„ ìˆœì„œ

1. **ê´€ë¦¬ì ìƒí’ˆ ë“±ë¡ ê¸°ëŠ¥** ê°œì„ 
2. **ì£¼ë¬¸ ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ** ì™„ì„±
3. **ì‹¤ì‹œê°„ ì•Œë¦¼ ì‹œìŠ¤í…œ** êµ¬í˜„
4. **ê²°ì œ ì‹œìŠ¤í…œ** ì—°ë™
5. **ë°°ë‹¬ ì¶”ì ** ê¸°ëŠ¥

## ğŸ“ í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

### ì¬ê³  ê´€ë¦¬ í…ŒìŠ¤íŠ¸
1. ìƒí’ˆ ì¬ê³ ë¥¼ 1ê°œë¡œ ì„¤ì •
2. 2ê°œ ì£¼ë¬¸ ì‹œë„ â†’ ì¬ê³  ë¶€ì¡± ì—ëŸ¬ í™•ì¸
3. 1ê°œ ì£¼ë¬¸ ì„±ê³µ â†’ í’ˆì ˆ ìƒíƒœë¡œ ë³€ê²½ í™•ì¸
4. ì£¼ë¬¸ ì·¨ì†Œ â†’ ì¬ê³  ë³µêµ¬ í™•ì¸

### ë™ì‹œ ì£¼ë¬¸ í…ŒìŠ¤íŠ¸
1. ê°™ì€ ìƒí’ˆì— ëŒ€í•´ ë™ì‹œì— ì—¬ëŸ¬ ì£¼ë¬¸
2. ì¬ê³ ë³´ë‹¤ ë§ì€ ì£¼ë¬¸ì´ ë“¤ì–´ì˜¬ ë•Œ ì²˜ë¦¬ í™•ì¸

ì´ì œ ì£¼ë¬¸ ì‹œìŠ¤í…œì˜ í•µì‹¬ ê¸°ëŠ¥ì´ ì™„ì„±ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰